<html>

    <head>
    </head>
    
    <body onload="main(document.getElementById('graphContainer'))">


        <script type="text/javascript">
         mxBasePath = './mxgraph/src';
        </script>
        <script type="text/javascript" src="./mxgraph/mxClient.min.js"></script>

        <script type="text/javascript" src="./objGraph.js"></script>


        <script>

         

         function checkReturn(exports){
             if( exports == null || typeof(exports) == "undefined" || exports.scope == null || typeof(exports.scope) == "undefined" ){
                 const editor = document.getElementById("codeEditor");

                 const sampleConfig = {
                     scope : {
                         theArray: [1,2,[3,4],"Last"],
                         theString: "Hello, objGraph.js!"
                     },
                     extractors : ["length"]
                 };
                 
                 editor.value += "\n// MISSING module.exports.scope . EXAMPLE:\nmodule.exports = " + JSON.stringify(sampleConfig,null,2) + ";";
                 
             }
         }

         function executeCodeEditor(){
             const editor = document.getElementById("codeEditor");
             const epe = document.getElementById("enumerablePropertiesExtractor").checked;
             const che = document.getElementById("classHierarchyExtractor").checked;
             const tse = document.getElementById("toStringExtractor").checked;
             const pe = document.getElementById("propertiesExtractor").value;
             
             const code = editor.value;
             const fun = new Function(
                 "const module = {exports: {scope: null} };\n" +
                 code +
                 "\ncheckReturn(module.exports);" +
                 "\nreturn module.exports;");
             const exports = fun();
             if( !exports.extractors ){
                 exports.extractors = [];
             }


             //luis bravo mendez Envera

             with(objGraph){

                 let extractors = [];
                 if( epe ){
                     extractors.push( EnumerablePropertiesExtractor );
                 }
                 if( tse ){
                     extractors.push( ToStringExtractor );
                 }
                 if( che ){
                     extractors.push( PrototypeExtractor );
                     extractors.push( "prototype" );
                 }

                 if( pe ){
                     const properties = pe.split(/[\s,]+/);
                     console.log(properties);
                     properties.forEach( p => extractors.push(p) );
                 }

                 console.log("extractors:" + extractors );
                 
                 const config = {
                     scope: exports.scope,
                     extractors: exports.extractors.concat(extractors),
                     filter : exports.filter
                 };
                 mxgraph.getModel().clear();
                 console.log("Creating graph.");
                 const objgraph = createObjGraph(config);
                 console.log("Graph created.");
                 objgraph.toMxGraph(window.mxgraph);

                 let layout = new mxHierarchicalLayout(window.mxgraph);
                 layout.execute(window.mxgraph.getDefaultParent())

             }

         }
         
         
         function main(container){
             // Checks if the browser is supported
             if (!mxClient.isBrowserSupported()) {
                 // Displays an error message if the browser is not supported.
                 mxUtils.error('Browser is not supported!', 200, false);
             }
             else{
                 // Disables the built-in context menu
                 mxEvent.disableContextMenu(container);
                 
                 // Creates the graph inside the given container
                 var graph = new mxGraph(container);
                 window.mxgraph = graph;

                 graph.addListener(mxEvent.MOVE_CELLS, function(e){
                 });

                 // Enables rubberband selection
                 new mxRubberband(graph);

                 // Changes the default vertex style in-place
                 var style = graph.getStylesheet().getDefaultVertexStyle();
                 style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                 //style[mxConstants.STYLE_GRADIENTCOLOR] = 'white';
                 style[mxConstants.STYLE_PERIMETER_SPACING] = 6;
                 style[mxConstants.STYLE_ROUNDED] = true;
                 //style[mxConstants.STYLE_SHADOW] = true;

                 style = graph.getStylesheet().getDefaultEdgeStyle();
                 //style[mxConstants.STYLE_ROUNDED] = true;

                 
                 
                 // Adds cells to the model in a single step
                 graph.getModel().beginUpdate();
                 try{
                     //fillTestGraph(graph);
                     //fillItself(graph);
                     //fillBidimensionalArray(graph);
                 }
                 finally{
                     // Updates the display
                     graph.getModel().endUpdate();
                 }

                 mxHierarchicalLayout.prototype.edgeStyle = mxHierarchicalEdgeStyle.CURVE;
                 let layout = new mxHierarchicalLayout(graph);
                 layout.edgeStyle = mxHierarchicalEdgeStyle.CURVE;
                 layout.execute(graph.getDefaultParent())
             }


             
         }

        </script>

        <style>
         #graphContainer{
             width: 50%;
             height: 100%;
             display: inline-block;
             overflow: scroll;
         }
         #editorFrame{
             width: 49%;
             height: 100%;
             display: inline-block;
         }
         #codeEditor{
             height: 70%;
             width: 100%;
             display: block;
         }
         row{
             display: block;
         }
         body{
             overflow: hidden;
         }
        </style>

        <div id="graphContainer"></div>
        <div id="editorFrame">
            Se crear√° un diagrama de los objetos accesibles en <code>module.exports.scope</code>
            <textarea id="codeEditor">
            </textarea>
            <row>
                <label for="enumerablePropertiesExtractor">Todas las propiedades enumerables</label>
                <input id="enumerablePropertiesExtractor" type="checkbox"/>
            </row>
            <row>
                <label for="classHierarchyExtractor">prototype y [[prototype]]</label>
                <input id="classHierarchyExtractor" type="checkbox"/>
            </row>
            <row>
                <label for="toStringExtractor">toString()</label>
                <input id="toStringExtractor" type="checkbox"/>
            </row>
            <row>
                <label for="propertiesExtractor">Otras propiedades (separadas por comas)</label>
                <input id="propertiesExtractor" type="text"></input>
            </row>
            <row>
                <input type="button" value="eval" onclick="executeCodeEditor()"/>
            </row>
        </div>
        

    </body>

</html>

